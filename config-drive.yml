---
- hosts: localhost
  vars:
    ssh_public_key_path: ~/.ssh/id_rsa.pub
    ansible_python_interpreter: /usr/bin/python # avoids lack of python3 bindings for yum
  roles:
    - role: ansible-role-configdrive # install from https://gitlab.com/davidblaisonneau-orange/ansible-role-configdrive
      configdrive_os_family: "RedHat"
      configdrive_uuid: "openhpc2"
      configdrive_fqdn: "test.example.com"
      configdrive_name: "openhpc2"
      configdrive_ssh_public_key: "{{ lookup('file', ssh_public_key_path) }}"
      configdrive_config_dir: "/tmp/configdrive/"
      configdrive_volume_path: "{{ playbook_dir }}"
      configdrive_config_dir_delete: True
      configdrive_network_device_list: []
  tasks:
    - name: Ensure configdrive is decoded and decompressed
      shell: >
          base64 -d {{ playbook_dir }}/openhpc2.gz
          | gunzip
          > {{ playbook_dir }}/config-drive.iso
