# NB: this only works on centos 8 / ohpc v2 as we want UCX
# TODO: add support for groups/partitions
# Currently need to run with something like:
#   ANSIBLE_LIBRARY=. ansible-playbook -i inventory test.yml

- hosts: cluster
  name: Export/mount /opt via NFS for ohcp and intel packages
  become: yes
  tags: setup
  tasks:
    - import_role:
        name: stackhpc.nfs
      vars:
        nfs_enable:
          server:  "{{ inventory_hostname in groups['cluster_login'] | first }}"
          clients: "{{ inventory_hostname in groups['cluster_compute'] }}"
        nfs_server: "{{ hostvars[groups['cluster_login'] | first ].ansible_default_ipv4.address }}"
        nfs_export: "/opt"
        nfs_client_mnt_point: "/opt"
    - name: install libpmi for slurm (needed for srun with intel mpi)
      yum:
        name: slurm-libpmi-ohpc
        state: present
        
- hosts: cluster_login[0]
  name: Run tests
  tags: test
  tasks:
    - import_role:
        name: stackhpc.slurm_openstack_tools.test
      vars:
        openhpc_tests_rootdir: /mnt/nfs/ohcp-tests
        openhpc_tests_hpl_NB: 192

- hosts: cluster_compute
  name: Unmount /opt from compute
  become: yes
  tags: cleanup
  tasks:
    - mount:
        path: "/opt"
        state: unmounted

# NB: cleanup is not perfect - leaves NFS running (b/c might not just be /opt) and leaves slurm-libpmi-ohpc installed (b/c it might have been)
- hosts: cluster_login[0]
  name: Remove /opt export
  tags: cleanup
  become: yes
  tasks:
  - name: update exports file
    lineinfile:
      path: /etc/exports
      regexp: "/opt"
      state: absent
  - name: update exported filesystems
    command: exportfs -r
