---
- name: Create virtualenv
  pip:
    name: git+https://github.com/jovial/slurm-stats@feature/packaging
    virtualenv: /opt/venvs/slurm-stats
    virtualenv_command: python3 -m venv
  become: true

- name: Create a directory to house the log files
  file:
    state: directory
    path: /var/log/slurm-stats
  become: true

- name: Create cron job
  cron:
    name: Generate slurm stats
    minute: "*/5"
    user: root
    # NOTE: lasttimestamp is stored at /root/lasttimestamp
    job: "TZ=UTC /opt/venvs/slurm-stats/bin/sacct.py >> /var/log/slurm-stats/finished_jobs.json"
    cron_file: slurm-stats
  become: true

- name: Setup log rotate
  copy:
    content: |
      # WARNING: This file is managed by ansible, do not modify.
      /var/log/slurm-stats/finished_jobs.json {
              daily
              rotate 7
              compress
              delaycompress
      }
    dest: /etc/logrotate.d/slurm-stats
  become: true