- name: Create temporary file for autogenerated NHC configuration
  ansible.builtin.tempfile:
  register: nhc_tempfile

- name: Run NHC autoconfiguration
  ansible.builtin.command:
    cmd: "nhc-genconf -c {{ nhc_tempfile.path }}"
  register: _nhc_genconf
  failed_when: _nhc_genconf.rc > 1 # https://github.com/mej/nhc/issues/158

- name: Apply modifications to autogenerated NHC configuration
  ansible.builtin.lineinfile: "{{ item | combine(nhc_lineinfile_defaults) }}"
  loop: "{{ nhc_config_changes }}"
  vars:
    nhc_lineinfile_defaults:
      path: "{{ nhc_tempfile.path }}"

- name: Remove timestamp from autogenerated NHC configuration
  # for idempotency
  ansible.builtin.replace:
    path: "{{ nhc_tempfile.path }}"
    # note this matches a multiline string:
    regexp: '# This file was automatically generated by nhc-genconf\n#.*'
    replace: '# This file was automatically generated by nhc-genconf\n# (timestamp removed for idempotency)'

- name: Copy modified NHC configuration to active location
  ansible.builtin.copy:
    remote_src: true
    src: "{{ nhc_tempfile.path }}"
    dest: /etc/nhc/nhc.conf
    owner: root
    group: root
    mode: u=rw,go= # HealthCheckProgram is run by root
