- block:
  - name: Wait for mysql to initialise
    # NB: It is not sufficent to wait_for the port
    community.mysql.mysql_info:
      login_user: root
      login_password: "{{ mysql_root_password }}"
      login_port: 30004
    #no_log: "{{ no_log | default(true) }}"
    register: _mysql_info
    until: "'version' in _mysql_info"
    retries: 90
    delay: 2

  - name: Ensure mysql databases created
    no_log: true
    community.mysql.mysql_db: "{{ item }}"
    loop: "{{ mysql_databases}}"

  - name: Ensure mysql users present
    no_log: true
    community.mysql.mysql_user: "{{ item }}"
    loop: "{{ mysql_users }}"
  when: "mysql_state | default('unspecified') != 'stopped'"
