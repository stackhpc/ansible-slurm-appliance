- name: Install pip
  dnf:
    name: python3-pip

- name: Install python mysql client
  pip:
    name:
      - pymysql
      - cryptography
    state: present

- name: Creating namespace
  kubernetes.core.k8s:
    name: "{{ mysql_kube_namespace }}"
    api_version: v1
    kind: Namespace
    state: present

- name: Disable rancher default storage class
  kubernetes.core.k8s:
    namespace: "{{ mysql_kube_namespace }}"
    state: patched
    definition:
      kind: StorageClass
      metadata:
        name: local-path
        annotations:
          storageclass.kubernetes.io/is-default-class: "false"

- name: Create mysql hostPath volume in /var/lib/state
  kubernetes.core.k8s:
    namespace: "{{ mysql_kube_namespace }}"
    definition:
      apiVersion: v1
      kind: PersistentVolume
      metadata:
        name: mysql-test
        labels:
          app.kubernetes.io/name: mysql-test
      spec:
        capacity:
          storage: 1Gi # not enforced for hostpath volumes but requires value >0 to work
        accessModes:
        - ReadWriteOnce
        hostPath:
          path: "{{ mysql_datadir }}"
          type: DirectoryOrCreate

- name: Create pvc
  kubernetes.core.k8s:
    namespace: "{{ mysql_kube_namespace }}"
    definition:
      apiVersion: v1
      kind: PersistentVolumeClaim
      metadata:
        name: sql-pvc
      spec:
        accessModes:
        - ReadWriteOnce
        resources:
          requests:
            storage: 1Gi
        volumeMode: Filesystem
        volumeName: mysql-test

- name: Install mysql helm chart
  kubernetes.core.helm:
    chart_ref: mysql
    chart_repo_url: https://charts.bitnami.com/bitnami
    chart_version: 11.1.19
    release_namespace: "{{ mysql_kube_namespace }}"
    release_name: sqlrelease
    release_values:
      image:
        tag: "{{ mysql_tag }}"
      volumePermissions:
        enabled: true
      auth:
        rootPassword: "{{ mysql_root_password }}"
      primary:
        persistence:
          existingClaim: sql-pvc
        nodeSelector:
          clusterrole: server
        service:
          type: NodePort
          nodePorts:
            mysql: "{{ mysql_port }}"
      networkPolicy:
        enabled: false
    atomic: no
    create_namespace: no
    wait: yes
