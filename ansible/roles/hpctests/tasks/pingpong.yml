---
- name: Make directory
  ansible.builtin.file:
    path: "{{ hpctests_rootdir }}/pingpong"
    state: directory
    mode: "0755"

- name: Create sbatch script
  ansible.builtin.template:
    src: pingpong.sh.j2
    dest: "{{ hpctests_rootdir }}/pingpong/pingpong.sh"
    mode: "0755"

- name: Run pingpong
  block:
    - name: Submit jobscript # noqa: command-instead-of-shell no-changed-when
      ansible.builtin.shell: bash -l -c 'sbatch --wait pingpong.sh' # need login shell for module command
      args:
        chdir: "{{ hpctests_rootdir }}/pingpong"
      register: hpctests_pingpong_sbatch
  rescue:
    - name: Get slurm job output
      ansible.builtin.slurp:
        src: "{{ hpctests_rootdir }}/pingpong/pingpong.sh.out"
      register: _pingpong_out
    - name: Show job output
      ansible.builtin.debug:
        msg: |
          PingPong output was:

          {{ _pingpong_out.content | b64decode }}
      failed_when: true

- ansible.builtin.set_fact:
    _pingpong_jobid: "{{ hpctests_pingpong_sbatch.stdout.split()[-1] }}"
- ansible.builtin.set_fact:
    _pingpong_local_output: "{{ hpctests_outdir }}/pingpong/{{ _pingpong_jobid }}/pingpong.sh.out"

- name: Retrieve results file
  ansible.builtin.fetch:
    src: "{{ hpctests_rootdir }}/pingpong/pingpong.sh.out"
    dest: "{{ _pingpong_local_output }}"
    flat: true

- name: Read pingpong results
  read_imb_pingpong:
    path: "{{ _pingpong_local_output }}"
  register: hpctests_pingpong_out
  delegate_to: localhost
  become: false

- name: Read nodes used # noqa: no-changed-when
  ansible.builtin.command: "grep 'SLURM_JOB_NODELIST:' {{ _pingpong_local_output }}"
  register: hpctests_pingpong_run_nodes
  delegate_to: localhost
  become: false

- name: Plot image
  ansible.builtin.command:
    cmd: "python {{ role_path }}/files/plot_imb_pingpong.py {{ _pingpong_local_output }}"
    creates: "{{ _pingpong_local_output | dirname }}/latency.png"
  register: _pingpong_plot
  delegate_to: localhost
  become: false
  when: hpctests_pingpong_plot | bool

- ansible.builtin.debug:
    # yamllint disable rule:line-length
    msg: |
      Summary for pingpong using 2x scheduler-selected nodes in '{{ hpctests_partition }}' partition, job ID {{ _pingpong_jobid }}, device '{{ hpctests_ucx_net_devices }}':

      Nodes: {{ hpctests_pingpong_run_nodes.stdout.split()[1] }}
      Zero-size msg latency: {{ hpctests_pingpong_out['columns']['latency'][0] }} us
      Max bandwidth: {{ hpctests_pingpong_out['columns']['bandwidth'] | max }} Mbytes/s ({{ (hpctests_pingpong_out['columns']['bandwidth'] | max) / 125.0 }} Gbit/s)

      {% if hpctests_pingpong_plot %}
      See plot on localhost:
      {{ _pingpong_plot.stdout }}
      {% endif %}
    # yamllint enable rule:line-length
