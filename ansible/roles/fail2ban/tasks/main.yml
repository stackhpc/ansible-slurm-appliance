---
- name: Install EPEL repo
  package:
    name: epel-release

- name: Install fail2ban packages
  package:
    name:
      - fail2ban-server
      - fail2ban-firewalld
    state: present

- name: Allow cluster subnet through filewalld
  ansible.posix.firewalld:
    permanent: yes
    source: "{{ fail2ban_cluster_subnet }}"
    zone: "{{ fail2ban_cluster_subnet_zone }}"
    state: enabled
  notify: Restart filewalld
  loop: "{{ fail2ban_firewalld_configs }}"

- name: Create config
  template:
    dest: /etc/fail2ban/jail.local
    src: jail.local.j2
  notify: Restart fail2ban

- name: flush handlers
  meta: flush_handlers

- name: Ensure filewalld running even if no config change
  service:
    name: firewalld
    state: started
    enabled: true

- name: Ensure fail2ban running even if no config change
  service:
    name: fail2ban
    state: started
    enabled: true
