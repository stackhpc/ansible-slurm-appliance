- name: Ensure mount directories exist
  ansible.builtin.file:
    path: "{{ item.value.path }}"
  loop: "{{ mounts | dict2items }}"

- name: Ensure tmp.mount mask status is correct
  # RL8-specific fix; otherwise rootfs comes up read-only after a reboot!
  # Note tmp.mount is a special case because the mount unit is shipped, rather
  # than being autogenerated: `ls /usr/lib/systemd/system/*.mount` shows
  # shipped ones.
  ansible.builtin.systemd:
    name: tmp.mount
    masked: "{{ tmp_masked }}"
  vars:
    tmp_mount: "{{ mounts_default.values() | selectattr('path', 'eq', '/tmp') }}"
    tmp_masked: "{{ false if ((tmp_mount | length > 0) and (tmp_mount.0.enabled | default(true))) else true }}"

- name: Ensure mount
  ansible.posix.mount:
    path: "{{ item.value.path }}"
    src: "{{ item.value.src }}"
    fstype: "{{ item.value.fstype }}"
    state: "{{ item.value.state }}"
    opts: "{{ item.value.opts | default(omit) }}"
  loop: "{{ mounts | dict2items }}"
  when: item.value.enabled | default(true)
