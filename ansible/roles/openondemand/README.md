# Role Name

Install and configure the [Open Ondemand](https://osc.github.io/ood-documentation/latest/) browser-based portal.

This uses the [osc.ood](https://github.com/OSC/ood-ansible) Ansible role to provide much of the functionality.

## Requirements

- An OpenHPC v2.4 or later cluster (due to [this issue](https://github.com/openhpc/ohpc/issues/1346) in previous versions).
- The `openondemand` node, i.e. the node which will host the Open Ondemand server/portal must:
  - Have the slurm packages (e.g. `sinfo` etc) installed and be able to contact the Slurm controller (e.g. add this node to the `login` group).
  - Have access to any cluster shared filesystems.
- Open Ondemand's authentication maps authenticated users (e.g. via OIDC) to local users on the `openondemand` node (see `openondemand_mapping_users`). You must therefore ensure that whatever is providing users for the cluster covers the `openondemand` node, e.g. if using `basic_users` role ensure the group for this includes the `openondemand` group.

## Role Variables

### Authentication
See the Open Ondemand [Authentication docs](https://osc.github.io/ood-documentation/latest/authentication/overview.html) for an overview of the authentication process.

- `openondemand_auth`: Required. Authentication method, either `'oidc'` or `'pam'`.
- `openondemand_mapping_users`: Required for `openondemand_auth=='oidc'`. A list of dicts defining mappings between remote authenticated usernames and local system usernames - see the Open Ondemand [user mapping docs](https://osc.github.io/ood-documentation/latest/authentication/overview/map-user.html). Each dict should have the following keys:
  - `name`: A local (existing) user account
  - `openondemand_username`: The remote authenticated username. See also `openondemand_oidc_remote_user_claim` if using OIDC authentication.

#### OIDC authentication
The following variables are active when `openondemand_auth` is `oidc`. This role uses the variables below plus a few required defaults to set the `osc.ood: ood_auth_openidc` [variable](https://github.com/OSC/ood-ansible#open-id-connect) - if the below is insufficent to correctly configure OIDC then set `ood_auth_openidc` directly.
- `openondemand_oidc_client_id`: Required. Client ID, as specified by the OIDC provider
- `openondemand_oidc_client_secret`: Required. Client secret, as specified the OIDC provider (should be vault-protected).
- `openondemand_oidc_provider_url`: Required. URL including protocol for the OIDC provider.
- `openondemand_oidc_crypto_passphrase`: Required. Random string (should be vault protected)
- `openondemand_oidc_scope`: Optional. A space-separated string giving the [OIDC scopes](https://auth0.com/docs/configure/apis/scopes/openid-connect-scopes) to request from the OIDC provider. What is available depends on the provider. Default: `openid profile preferred_username`.
- `openondemand_oidc_remote_user_claim`: Optional. A string giving the [OIDC claim](https://auth0.com/docs/configure/apis/scopes/openid-connect-scopes#standard-claims) to use as the remote user name. What is available depends on the provider and the claims made. Default: `preferred_username`.

The OIDC provider should be configured to redirect to `https://{{ openondemand_servername }}/oidc` with scopes as appropriate for `openondemand_oidc_scope`.

### SSL Certificates
This role enables SSL on the Open Ondemand server, using the following self-signed certificate & key which are autogenerated by the `mod_ssl` package installed as part of the `ondemand-apache` package. Replace with your own keys if required.
- `openondemand_ssl_cert`: Optional. Default `/etc/pki/tls/certs/localhost.crt`.
- `openondemand_ssl_cert_key`: Optional. Default `/etc/pki/tls/private/localhost.key`

### Dashboard and application configuration
- `openondemand_dashboard_docs_url`: Optional. URL of docs to show under Help in dashboard. Default `(undefined)`.
- `openondemand_dashboard_links`: Optional. List of mappings defining additional links to add as menu items in the dashboard. Keys are:
    - `name`: Required. User-facing name for the link.
    - `category`: Required. Menu to add link under, either a default one (e.g. `Files`, `Jobs`, `Clusters`, `Interactive Apps`) or a new category to add.
    - `icon`: Optional. URL of icon, defaults to Open Ondemand clock icon as used in standard menus.
    - `url`: Required. URL of link.
    - `new_window`: Optional. Whether to open link in new window. Bool, default `false`.
    - `app_name`: Optional. Unique name for app appended to `/var/www/ood/apps/sys/`. Default is `name`, useful if that is not unique or not suitable as a path component.
- `openondemand_dashboard_support_url`: Optional. URL or email etc to show as support contact under Help in dashboard. Default `(undefined)`.
- `openondemand_desktop_partition`: Optional. Name of Slurm partition to use for remote desktops. Requires a corresponding group named "openondemand_desktop" and entry in openhpc_slurm_partitions.
- `openondemand_filesapp_paths`: List of paths (in addition to $HOME, which is always added) to include shortcuts to within the Files dashboard app.
- `openondemand_jupyter_partition`: Required. Name of Slurm partition to use for Jupyter Notebook servers. Requires a corresponding group named "openondemand_jupyter" and entry in openhpc_slurm_partitions.

### Monitoring
- `openondemand_exporter`: Optional. Install the Prometheus [ondemand_exporter](https://github.com/OSC/ondemand_exporter) on the `openondemand` node to export metrics about Open Ondemand itself. Default `true`.

### Other
This role provides synonoyms for some additional [osc.ood](https://github.com/OSC/ood-ansible) role variables: 

- `openondemand_clusters`: Required. Synonym for the `osc.ood: clusters` [variable](https://github.com/OSC/. ood-ansible#clusters). Default: empty mapping.
- `openondemand_servername`: Required. Synonym for the `osc.ood: servername` [variable](servername), defining the `ServerName` for the Open Ondemand [name-based virtual host](https://httpd.apache.org/docs/current/mod/core.html#servername). This should the IP or hostname(+domain) part of the URL used to access Open Ondemand in the browser, e.g. `ondemand.mysite.org`. If using ssh proxying to get to the Open Ondemand server, this should be `localhost`.
- `openondemand_host_regex`: Synomyn for the `osc.ood: host_regex` [variable](https://osc.github.io/ood-documentation/latest/app-development/interactive/setup/enable-reverse-proxy.html). A Python regex matching cluster hostnames which Open Ondemand should proxy. Required to proxy Grafana from control node or to run interactive apps such as remote desktop or Jupyter notebook server. Note the osc.ood variables `node_uri` and `rnode_uri` are set automatically if this is added.

# Dependencies

- `osc.ood` role as described above.

- Note the `osc.ood: servername` variable is important, and has a default of "localhost" - this misconfigures name-based virtual hosting if using ip address and in this case you must set `servername:` to effectively undefine it.

# Example Playbook

See `ansible/portal.yml`. Note the `main` playbook should be run on the `openondemand` node (i.e. the node to configure as hosting the Open Ondemand server/portal), and the other playbooks should be run on some subset of the `compute` group.

# License

Apache v2

# Author Information

Stackhpc Ltd.

# TODOs
- Support PAM auth (as default when `basic_users` is enabled?): https://osc.github.io/ood-documentation/latest/authentication/pam.html
- Support ways other than `openondemand_mapping_users` of setting [user mappings](https://osc.github.io/ood-documentation/latest/authentication/overview/map-user.html).
