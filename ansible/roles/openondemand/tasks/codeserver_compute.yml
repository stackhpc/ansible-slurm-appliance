- name: Download Code Server RPM
  ansible.builtin.get_url:
    url: "https://github.com/coder/code-server/releases/download/v{{ openondemand_code_server_version }}/code-server-{{ openondemand_code_server_version }}-amd64.rpm" # noqa: yaml[line-length]
    dest: /tmp/code-server.rpm
    mode: '0644'

- name: Install Code Server
  # checkov:skip=CKV2_ANSIBLE_4: "Ensure that packages with untrusted or missing GPG signatures are not used by dnf"
  ansible.builtin.dnf:
    name: /tmp/code-server.rpm
    state: present
    disable_gpg_check: true

- name: Create module directory for Code Server
  ansible.builtin.file:
    path: /opt/ohpc/pub/modulefiles/code-server
    state: directory
    mode: '0755'
    recurse: true

- name: Create modulefile for Code Server
  ansible.builtin.copy:
    dest: "/opt/ohpc/pub/modulefiles/code-server/{{ openondemand_code_server_version }}"
    mode: "0644"
    content: |
      #%Module1.0#####################################################################

      proc ModulesHelp { } {
          puts stderr "This module loads code-server {{ openondemand_code_server_version }}."
          puts stderr "\nCode Server provides a browser-based VSCode instance.\n"
      }

      module-whatis "Name: code-server"
      module-whatis "Version: {{ openondemand_code_server_version }}"
      module-whatis "Category: IDE"
      module-whatis "Description: Run VS Code in your browser with Code Server"
      module-whatis "URL: https://github.com/coder/code-server"

      set root /usr/bin/code-server

      prepend-path PATH $root
