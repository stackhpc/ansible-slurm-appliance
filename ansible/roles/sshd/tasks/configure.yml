- name: Ensure drop in directory exists
  file:
    path: /etc/ssh/sshd_config.d/*.conf
    state: directory
    owner: root
    group: root
    mode: 700
  become: true

- name: Ensure drop in directory is included
  lineinfile:
    dest: /etc/ssh/sshd_config
    regexp: "^Include /etc/ssh/sshd_config.d/*.conf"
    line: "Include /etc/ssh/sshd_config.d/*.conf"
    state: present
    insertafter: EOF
    validate: sshd -t -f %s
  notify:
    - Restart sshd
  become: true

- name: Template sshd configuration
  # NB: If parameters are defined multiple times the first value wins;
  # The default /etc/ssh/sshd_config has
  #   Include /etc/ssh/sshd_config.d/*.conf
  # early on, which is generally held to be the correct approach, so adding
  # values to the end of that file won't work
  template:
    src: "{{ sshd_conf_src }}"
    dest: "{{ sshd_conf_dest }}"
    owner: root
    group: root
    mode: u=rw,go=
    validate: sshd -t -f %s
  notify:
    - Restart sshd
