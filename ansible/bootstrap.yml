---

- hosts: cluster
  gather_facts: false
  tasks:
    - name: Add users
      ansible.builtin.user: "{{ item }}"
      with_items: "{{ appliances_local_users }}"
      become: true

- hosts: selinux
  gather_facts: false
  become: yes
  tags:
    - selinux
  tasks:
    - name: Set SELinux state and policy
      ansible.posix.selinux:
        state: "{{ selinux_state }}"
        policy: "{{ selinux_policy }}"
      register: sestatus
    - name: Reboot if required to change SELinux state
      reboot:
      when: sestatus.reboot_required
    - name: Wait for hosts to be reachable
      wait_for_connection:
        delay: 30
        sleep: 5
      when: sestatus.reboot_required
    - name: update facts
      setup:
      when: sestatus.changed

- hosts: update
  gather_facts: false
  become: yes
  tags:
    - update
  tasks:
    - name: Update selected packages
      yum:
        name: "{{ update_name }}"
        state: "{{ update_state }}"
        exclude: "{{ update_exclude }}"
      when: "update_enable | default('false') | bool"
