---
- hosts: login:!builder # won't have a slurm control daemon when in build
  become: false
  gather_facts: false
  tasks:
    - name: Run sinfo
      ansible.builtin.shell: 'sinfo --noheader --format="%N %P %a %l %D %t" | sort' # noqa: risky-shell-pipe
      register: sinfo
      changed_when: false
      until: sinfo.stdout_lines == expected_sinfo
      retries: 200
      delay: 5
      vars:
        expected_sinfo:
          - " extra up 60-00:00:00 0 n/a" # empty partition
          - "{{ openhpc_cluster_name }}-compute-[0-1] standard* up 60-00:00:00 2 idle"
