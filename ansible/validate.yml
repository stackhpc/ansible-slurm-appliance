---

# Fail early if configuration is invalid

- name: Validate filebeat configuration
  hosts: filebeat
  tags: filebeat
  tasks:
    - import_role:
        name: filebeat
        tasks_from: validate.yml
      tags: validate

- name: Validate kibana configuration
  hosts: kibana
  tags: kibana
  tasks:
    - import_role:
        name: kibana
        tasks_from: validate.yml
      tags: validate

- name: Validate opendistro configuration
  hosts: opendistro
  tags: opendistro
  tasks:
    - import_role:
        name: opendistro
        tasks_from: validate.yml
      tags: validate

- name: Validate rebuild configuration
  hosts: openhpc
  gather_facts: false
  tags: rebuild
  tasks:
    - block:
      - stat:
          path: "{{ openhpc_rebuild_clouds }}"
        register: openhpc_clouds_path
      - name: Check OpenRC file (openhpc_rebuild_clouds) exists
        assert:
          that: openhpc_clouds_path.stat.exists
          fail_msg: "openrc file {{ openhpc_rebuild_clouds }} on localhost (specified by `openhpc_rebuild_clouds`) does not exist"
      - name: Check OpenRC file (openhpc_rebuild_clouds) is usable
        shell: |
          source {{ openhpc_rebuild_clouds }}
          openstack token issue
        changed_when: false
      delegate_to: localhost
      delegate_facts: true
      run_once: true
