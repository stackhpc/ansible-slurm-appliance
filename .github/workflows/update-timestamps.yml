name: Check for new Release Train snapshots
on:
  workflow_dispatch:
  pull_request: #temporary 
  schedule:
    - cron: '0 7 * * *'  # Run at 7am on default branch

jobs:
  upstream_check:
    outputs:
      new_fatimage: "{{ steps.fatimage_check.outputs.new_fatimage }}"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - name: Check automation branch exists
        id: auto-branch-check
        run: |
          git fetch
          branches=$(git branch -r)
          set +e
          echo $branches | grep auto/bump-timestamps
          branch_exists="$?"
          echo "branch_exists=$branch_exists" >> "$GITHUB_OUTPUT"

      - name: Create automation branch
        if: steps.auto-branch-check.outputs.branch_exists == '1'
        run: |
          git checkout -b auto/bump-timestamps
          git config --global --add --bool push.autoSetupRemote true
          git push

      - uses: actions/checkout@v2
        with:
          ref: auto/bump-timestamps

      - name: Check for updated Ark timestamps and replace in defaults.yml
        run: |
          dev/setup-env.sh
          . venv/bin/activate
          . environments/.stackhpc/activate
          ansible-playbook ansible/ci/update_timestamps.yml -v

      - name: Check if timestamps were changed
        id: timestamp_check
        run: |
          set +e
          git diff --quiet
          echo "timestamps_changed=$?" >> "$GITHUB_OUTPUT"

      # TODO: find way to stop CI running if pushing to existing PR
      - name: Push new timestamps
        if: steps.timestamp_check.outputs.timestamps_changed == '1'
        run: |
          git add environments/common/inventory/group_vars/all/defaults.yml
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'
          git commit -m "Bumped repo timestamps"
          git notes add -m "timestamp_bump_commit"
          git config --global --add --bool push.autoSetupRemote true
          git push
          git push origin 'refs/notes/*'

      - name: Check if new fatimage needed
        id: fatimage_check
        run: |
          NEED_NEW_IMAGE=false
          set +e
          if $(git notes show) ; then
            HEAD_NOTES=$(git notes show)
            if [[ $HEAD_NOTES == "timestamp_bump_commit" ]] ; then
              NEED_NEW_IMAGE=true
            fi
          fi
          set -e
          echo "new_fatimage=$NEED_NEW_IMAGE" >> "$GITHUB_OUTPUT"

  
  # todo: don't skip if rerun
  build_fatimage:
    if: needs.upstream_check.outputs.new_fatimage == 'true'
    needs: upstream_check
    uses: stackhpc/ansible-slurm-appliance/.github/workflows/fatimage.yml@auto/bump-timestamps
    with:
      ci_cloud: LEAFCLOUD

  ci_and_pr:
    if: needs.upstream_check.outputs.new_fatimage == 'true'
    needs:
     - upstream_check
     - build_fatimage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          ref: auto/bump-timestamps

      - name: Bump CI with new images
        run: |
          git checkout auto/bump-timestamps
          sed -i 's/"RL8".*$/"RL8": "${{ needs.build_fatimage.outputs.openhpc-RL8-image }}"/' environments/.stackhpc/terraform/cluster_image.auto.tfvars.json
          sed -i 's/"RL9".*$/"RL9": "${{ needs.build_fatimage.outputs.openhpc-RL9-image }}"/' environments/.stackhpc/terraform/cluster_image.auto.tfvars.json 

      - name: Push new images
        run: |
          git add environments/.stackhpc/terraform/cluster_image.auto.tfvars.json
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'
          git commit -m "Bumped images"
          git push

      - name: Check if PR exists
        id: pr-check
        run: |
          set +e
          gh pr list --json headRefName --jq '.[].headRefName' | grep auto/bump-timestamps
          echo "pr_exists=$?" >> "$GITHUB_OUTPUT"

      - name: Create PR
        if: steps.pr-check.outputs.pr_exists
        run: gh pr create --title "[Auto] Bump repo timestamps to latest" --base main --head auto/bump-timestamps
