name: Build fat image
on:
  workflow_dispatch:
      inputs:
        ci_cloud:
          description: 'Select the CI_CLOUD'
          required: true
          type: choice
          options:
            - LEAFCLOUD
            - SMS
            - ARCUS
  workflow_call:
      inputs:
        ci_cloud_override:
          type: string
          default: LEAFCLOUD
        target_branch:
          type: string
          default: ${{ github.ref }}
      outputs:
        openhpc-RL8-image:
          description: "RL8 image"
          value: "${{ jobs.openstack.outputs.openhpc-RL8-image }}"
        openhpc-RL9-image:
          description: "RL9 image"
          value: "${{ jobs.openstack.outputs.openhpc-RL9-image }}"

jobs:
  openstack:
    name: openstack-imagebuild
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}-${{ matrix.build.image_name }} # to branch/PR + OS
      cancel-in-progress: true
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false # allow other matrix jobs to continue even if one fails
      matrix: # build RL8, RL9
        build:
          - image_name: openhpc-RL8
            source_image_name: Rocky-8-GenericCloud-Base-8.10-20240528.0.x86_64.qcow2
            inventory_groups: control,compute,login,update
          - image_name: openhpc-RL9
            source_image_name: Rocky-9-GenericCloud-Base-9.5-20241118.0.x86_64.qcow2
            inventory_groups: control,compute,login,update
    env:
      ANSIBLE_FORCE_COLOR: True
      OS_CLOUD: openstack
      CI_CLOUD: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.ci_cloud || inputs.ci_cloud_override }} # workaround for not being able to define string and choice in separate events
      ARK_PASSWORD: ${{ secrets.ARK_PASSWORD }}
      LEAFCLOUD_PULP_PASSWORD: ${{ secrets.LEAFCLOUD_PULP_PASSWORD }}
    outputs:
      openhpc-RL8-image: "${{ steps.manifest.outputs.openhpc-RL8-image }}"
      openhpc-RL9-image: "${{ steps.manifest.outputs.openhpc-RL9-image }}"

    steps:
      - uses: stackhpc/ansible-slurm-appliance/.github/actions/is_callee@feat/auto-bump-timestamps # todo: change to main once merges
        id: callee_check
        with:
          current_workflow_file: fatimage.yml

      - uses: actions/checkout@v3
        with:
          ref: ${{ steps.callee_check.outputs.is_callee && inputs.target_branch || github.ref }}

      - name: Record settings for CI cloud
        run: |
          echo CI_CLOUD: ${{ env.CI_CLOUD }}

      - name: Setup ssh
        run: |
          set -x
          mkdir ~/.ssh
          echo "${{ secrets[format('{0}_SSH_KEY', env.CI_CLOUD)] }}" > ~/.ssh/id_rsa
          chmod 0600 ~/.ssh/id_rsa
        shell: bash

      - name: Add bastion's ssh key to known_hosts
        run: cat environments/.stackhpc/bastion_fingerprints >> ~/.ssh/known_hosts
        shell: bash

      - name: Install ansible etc
        run: dev/setup-env.sh

      - name: Write clouds.yaml
        run: |
          mkdir -p ~/.config/openstack/
          echo "${{ secrets[format('{0}_CLOUDS_YAML', env.CI_CLOUD)] }}" > ~/.config/openstack/clouds.yaml
        shell: bash

      - name: Setup environment
        run: |
          . venv/bin/activate
          . environments/.stackhpc/activate

      - name: Build fat image with packer
        id: packer_build
        run: |
          set -x
          . venv/bin/activate
          . environments/.stackhpc/activate
          cd packer/
          packer init .

          PACKER_LOG=1 packer build \
          -on-error=${{ vars.PACKER_ON_ERROR }} \
          -var-file=$PKR_VAR_environment_root/${{ env.CI_CLOUD }}.pkrvars.hcl \
          -var "source_image_name=${{ matrix.build.source_image_name }}" \
          -var "image_name=${{ matrix.build.image_name }}" \
          -var "inventory_groups=${{ matrix.build.inventory_groups }}" \
          openstack.pkr.hcl

      - name: Get created image names from manifest
        id: manifest
        run: |
          . venv/bin/activate
          IMAGE_ID=$(jq --raw-output '.builds[-1].artifact_id' packer/packer-manifest.json)
          while ! openstack image show -f value -c name $IMAGE_ID; do
            sleep 5
          done
          IMAGE_NAME=$(openstack image show -f value -c name $IMAGE_ID)
          echo "image-name=${IMAGE_NAME}" >> "$GITHUB_OUTPUT"
          echo "image-id=$IMAGE_ID" >> "$GITHUB_OUTPUT"
          echo "${{ matrix.build.image_name }}-image=${IMAGE_NAME}" >> "$GITHUB_OUTPUT"
          echo $IMAGE_ID > image-id.txt
          echo $IMAGE_NAME > image-name.txt

      - name: Make image usable for further builds
        run: |
          . venv/bin/activate
          openstack image unset --property signature_verified "${{ steps.manifest.outputs.image-id }}"

      - name: Upload manifest artifact
        uses: actions/upload-artifact@v4
        with:
          name: image-details-${{ matrix.build.image_name }}
          path: |
            ./image-id.txt
            ./image-name.txt
          overwrite: true
