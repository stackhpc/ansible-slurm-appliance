#!/usr/bin/env python3
"""
SSH to a cluster host using connection properties from Ansible inventory.

Usage:
   ansible-ssh [-n] PATTERN

where PATTERN can be any of:
    - host e.g. mycluster-login-0
    - group e.g. login
    - group[index] e.g. compute[0]
options:
    -n      Disable strict host key checking and do not store accepted keys
"""

import json
import os
import shlex
import subprocess
import sys

NO_HOSTKEY_CHECK_OPTS = [
    "-o",
    "StrictHostKeyChecking=no",
    "-o",
    "GlobalKnownHostsFile=/dev/null",
    "-o",
    "UserKnownHostsFile=/dev/null",
]

if __name__ == "__main__":
    no_known_hosts = "-n" in sys.argv
    if sys.argv[-1] in (sys.argv[0], "-n"):
        print(__doc__, file=sys.stderr)
        sys.exit(-1)

    pattern = sys.argv[-1]

    template_str = (
        "ssh "
        "{% if ansible_ssh_port | default(false) %}-p {{ ansible_ssh_port }} {% endif %}"
        "{% if ansible_ssh_private_key_file | default(false) %} -i {{ ansible_ssh_private_key_file }} {% endif %}"
        "{{ ansible_ssh_common_args | default('') }} "
        "{{ ansible_user }}@{{ ansible_host }}"
    )
    module_args = json.dumps({"msg": template_str})
    ansible_cmd = ["ansible", pattern, "-o", "-m", "debug", "-a", module_args]
    try:
        output = subprocess.check_output(ansible_cmd, text=True)
    except subprocess.CalledProcessError:
        msg = "[ERROR]: ansible exited in error"
        print(msg, file=sys.stderr)
        sys.exit(-1)
    # output looks like e.g.
    # stg-login-0 | SUCCESS => {    "changed": false,    ...
    # one line per host
    if not output:
        sys.exit(1)
    result = output.splitlines()[0].split(">", 1)[-1]
    expanded = json.loads(result)["msg"]
    # can assume ansible_host exists b/c defined by terraform
    # can assume ansible_user exists b/c defined in common inventory

    cmd = shlex.split(expanded)
    if no_known_hosts:
        cmd = cmd[0:1] + NO_HOSTKEY_CHECK_OPTS + cmd[1:]

    print(f"[INFO]: Running: {subprocess.list2cmdline(cmd)}")
    os.execvp(cmd[0], cmd)
