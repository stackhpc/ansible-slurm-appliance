- hosts: localhost
  become: no
  gather_facts: false
  tasks:
    - block: 
      - name: Setup ssh
        shell: |
          set -x
          mkdir ~/.ssh
          echo "{{ lookup('env', 'BASTION_SSH_KEY') }}" > ~/.ssh/id_rsa
          chmod 0600 ~/.ssh/id_rsa
      - name: Add bastion's ssh key to known_hosts
        shell:
          cmd: "cat {{ appliances_environment_root }}/bastion_fingerprint >> ~/.ssh/known_hosts"
      when: "lookup('env', 'HOSTNAME') != 'steveb-deploy'"

- hosts: all
  become: no
  gather_facts: false
  tasks:
    - wait_for_connection:

- hosts: control:!builder
  become: yes
  gather_facts: false
  tasks:
    - name: Write CI-generated inventory and secrets for debugging
      ansible.builtin.copy:
        dest: /etc/ci-config/
        src: "{{ item }}"
        directory_mode: 0400
        mode: 0400
        owner: root
        group: root
      no_log: true
      loop:
        - "{{ lookup('env', 'APPLIANCES_ENVIRONMENT_ROOT') }}/inventory/hosts"
        - "{{ lookup('env', 'APPLIANCES_ENVIRONMENT_ROOT') }}/inventory/group_vars/all/secrets.yml"
        - "{{ lookup('env', 'APPLIANCES_ENVIRONMENT_ROOT') }}/inventory/group_vars/all/test_user.yml"
