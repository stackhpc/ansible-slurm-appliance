---

- name: "Add a stack admin user"
  hosts: all
  # tags: pre_tasks_all
  become: true
  gather_facts: true
  tasks:
    - name: Does localhome/stack dir exist
      ansible.builtin.stat:
        path: /localhome/stack
      register: localstack

    # - name: Does localhome/rocky dir exist
    #   ansible.builtin.stat:
    #     path: /localhome/rocky
    #   register: localrockyuserdir

    - name: Add stack user
      ansible.builtin.include_role:
        name: vs.core.stack_user
      when: not localstack.stat.exists

    # - name: Add rocky user role
    #   ansible.builtin.include_role:
    #     name: vshpc.rocky_user
    #   when: not localrockyuserdir.stat.exists
    #   tags:
    #     - add_stack_user
  tags:
    - add_stack_user

- name: A cp user home to /var/lib/USER
  hosts: all
  # tags: pre_tasks_all
  become: true
  gather_facts: false

- name: "Do the preliminary node setups"
  hosts: all
  # tags: pre_tasks_all
  become: true
  tasks:
    - name: Does vs_pre_complete.txt exist
      ansible.builtin.stat:
        path: /root/vs_pre_complete.txt
      register: vs_pre_complete

    - name: Pre tasks now
      vars:
        pre_all_packages: [] # moved to appliances_extra_packages_other
      ansible.builtin.include_role:
        name: vshpc.prov.pre-tasks
      when: not vs_pre_complete.stat.exists

- name: Ensure init.d symlink # Temporary workaround until https://github.com/stackhpc/ansible-slurm-appliance/issues/551 is fixed upstream
  hosts: all
  become: true
  tasks:
    - name: Create link
      ansible.builtin.file:
        src: /etc/rc.d/init.d
        dest: /etc/init.d
        owner: root
        group: root
        state: link
