- hosts: eessi:!builder
  become: yes
  gather_facts: no
  tags:
    - eessi
    - cvmfs
  tasks:
  # TODO: test this!
    - name: Add CVMFS config
      copy:
        dest: /etc/cvmfs/default.local
        content: |
          CVMFS_NFILES=262144
          CVMFS_REPOSITORIES=atlas.cern.ch,atlas-condb.cern.ch,grid.cern.ch
          CVMFS_CACHE_BASE=/var/cache/cvmfs2
          CVMFS_QUOTA_LIMIT=17000
          CVMFS_HTTP_PROXY='{{ groups['squid'] | map('extract', hostvars, 'ansible_host') | product([squid_http_port]) | map('join', ':') | join(';') }}'
          CVMFS_FORCE_SIGNING=True

- hosts: control:!builder
  become: yes
  gather_facts: no
  tags: openhpc
  vars:
    slurm_user_cmds:
      - sacct
      - sacctmgr
      - salloc
      - sattach
      - sbatch
      - sbcast
      - scancel
      - scontrol
      - scrontab
      - scrun
      - sdiag
      - sinfo
      - sprio
      - squeue
      - sreport
      - srun
      - sshare
      - sstat
      - strigger
      - munge # not really a user command but lives in same place
  tasks:
    # NB: NFS role ensures sussex_shared_slurm_path exists
    - name: Ensure {{ sussex_shared_slurm_path }} subdirectories exist
      file:
        path: "{{ sussex_shared_slurm_path }}/{{ item }}"
        state: directory
        owner: root
        group: root
        mode: ug=rwX,o=rX
      loop:
        - bin
        - etc
    - name: Copy slurm binaries into shared directory
      copy:
        remote_src: true
        src: "/usr/bin/{{ item }}"
        dest: "{{ sussex_shared_slurm_path }}/bin/{{ item }}"
        owner: root
        group: root
        mode: ug=rwx,o=rx
      loop: "{{ slurm_user_cmds }}"
    - name: Copy slurm.conf into shared directory
      copy:
        remote_src: true
        src: /etc/slurm/slurm.conf
        dest: "{{ sussex_shared_slurm_path }}/etc/slurm.conf"
        owner: root
        group: root
        mode: ug=rw,o=r
