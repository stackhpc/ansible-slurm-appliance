# As per the docs:
# - A partition entry may contain groups. If it doesn't the partition itself is the group.
# - Nodes can only be in one group (else slurmctld startup fails with "fatal: Duplicated NodeName"
#   due to the templating approach. Howver $group.partition_params.Nodes can be used to
#   override the automatic definition of Node=.
# - To avoid having to explicitly list the nodes, we can use the hostlist_expression
#   filter provided by the stackhpc.openhpc role. This works as this expression is
#   evaluated inside the role. NB: this filter returns a list.
_general_nodes:
  - "{{ groups[openhpc_cluster_name + '_general'] | hostlist_expression | join(',') }}"
  - "{{ groups[openhpc_cluster_name + '_a40_1024'] | hostlist_expression | join(',') }}"
  - "{{ groups[openhpc_cluster_name + '_a40_512'] | hostlist_expression | join(',') }}"

openhpc_slurm_partitions:
  - name: general # all nodes except grid - this templates the actual ${cluster_name}-general nodes ...
    partition_params:
      Nodes: "{{ _general_nodes | join(',') }}" # .. this adds the other nodes
    default: YES
  - name: grid
    default: NO
  - name: gpu # all GPU nodes
    groups:
      - name: a40_1024
        gres:
          - conf: gpu:A40:2
            file: /dev/nvidia[0-1]
      - name: a40_512
        gres:
          - conf: gpu:A40:2
            file: /dev/nvidia[0-1]
    default: NO

openhpc_config_extra: # parameters for slurm.conf
   GresTypes:
    - gpu
