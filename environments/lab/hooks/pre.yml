- name: NREL lab fixes - For compute nodes
  hosts: compute
  become: true
  gather_facts: false
  tags: scratch
  tasks:
    - name: Create scratch directory - on local SSD on prod
      file:
        path: /var/scratch
        state: directory

- name: Get custom slurm
  hosts: control
  become: true
  tasks:
  - name: Ensure temp directory
    file:
      path: /tmp/slurmdir
      state: directory

  - name: Download custom slurm
    ansible.builtin.get_url:
      url: http://tool.net/nrel-slurm.tgz
      dest: /tmp/slurmdir/slurm.tgz

  - name: Ensure exports directory
    file:
      path: /exports
      state: directory

  - name: Unarchive slurm
    ansible.builtin.unarchive:
      src: /tmp/slurmdir/slurm.tgz
      dest: /exports/
      remote_src: yes

- name: Import parent hook
  vars:
    appliances_environment_root: "{{ lookup('env', 'APPLIANCES_ENVIRONMENT_ROOT') }}"
  import_playbook: "{{ appliances_environment_root }}/../nrel/hooks/pre.yml"

