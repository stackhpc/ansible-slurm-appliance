---

- name: Configure Slurm MPI
  hosts: control
  become: true
  tags: openhpc
  tasks:
    - name: Template mpi.conf
      ansible.builtin.template:
        src: "{{ lookup('env', 'APPLIANCES_ENVIRONMENT_ROOT') }}/../site/templates/mpi.conf.j2"
        dest: /etc/slurm/mpi.conf
        owner: root
        group: root
        mode: 0644

- name: Enable and start service tmp.mount
  hosts: builder
  become: true
  tasks:
    - name: Enable service tmp.mount and ensure it is not masked
      ansible.builtin.systemd:
        name: tmp.mount
        enabled: true
        masked: no

    - name: Start service tmp.mount
      ansible.builtin.systemd:
        name: tmp.mount
        state: started

- name: Set up SSSD
  hosts: sssd
  tags: sssd
  become: true
  tasks:
    - name: Copy FreeIPA server cert
      ansible.builtin.copy:
        src: "{{ appliances_environment_root }}/../site/files/dl-auth.acrc.bris.ac.uk.cert"
        dest: "/etc/sssd/dl-auth.acrc.bris.ac.uk.cert"
    - name: Set SSSD for sudo
      ansible.builtin.lineinfile:
        path: /etc/nsswitch.conf
        regexp: '^sudoers:'
        line: "sudoers: files sss"
