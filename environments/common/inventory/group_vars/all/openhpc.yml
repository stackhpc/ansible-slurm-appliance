---

# See: https://github.com/stackhpc/ansible-role-openhpc
# for variable definitions

openhpc_enable:
  control: "{{ inventory_hostname in groups['control'] }}"
  batch: "{{ inventory_hostname in groups['compute'] }}"
  database: "{{ inventory_hostname in groups['control'] }}"
  runtime: true
openhpc_slurm_service_enabled: true
openhpc_slurm_accounting_storage_type: 'accounting_storage/slurmdbd'
openhpc_slurmdbd_mysql_database: slurm_acct_db
openhpc_slurmdbd_mysql_password: "{{ vault_mysql_slurm_password }}"
openhpc_slurmdbd_mysql_username: slurm
openhpc_slurm_control_host: "{{ groups['control'] | first }}" # avoid using hostvars for compute-init
openhpc_slurmdbd_host: "{{ openhpc_slurm_control_host }}"
openhpc_slurm_partitions:
  - name: "compute"
openhpc_packages_default:
  # system packages
  - podman
  # OpenHPC packages
  - slurm-libpmi-ohpc # to allow intel mpi to work properly
  - ohpc-gnu12-openmpi4-perf-tools # for hpctests
  - openblas-gnu12-ohpc # for hpctests (HPL)
  - nhc-ohpc # node health checks
  # EPEL packages:
  - apptainer
  - podman-compose
openhpc_packages_extra: []
openhpc_packages: "{{ openhpc_packages_default + openhpc_packages_extra }}"
openhpc_munge_key: "{{ vault_openhpc_mungekey | b64decode }}"
openhpc_login_only_nodes: login
openhpc_state_save_location: "{{ appliances_state_dir + '/slurmctld' if appliances_state_dir is defined else '/var/spool' }}"

# default extra config for the appliance:
openhpc_config_default:
  SlurmctldParameters:
    - enable_configless
  TaskPlugin: task/cgroup,task/affinity
  ReturnToService: 2 # is stackhpc.openhpc default, but templating bug means it is needed here too

# default additional config for "rebuild" group/role:
openhpc_config_rebuild:
  RebootProgram: /opt/slurm-tools/bin/slurm-openstack-rebuild
  SlurmctldParameters:
    - reboot_from_controller
  ResumeTimeout: 300

# default additional config for "nhc" group/role:
openhpc_config_nhc:
  HealthCheckProgram: /usr/sbin/nhc
  HealthCheckInterval: 300
  HealthCheckNodeState: NONDRAINED_IDLE

# additional site/environment-specific config:
# (should be overriden in environments/site/inventory/group_vars/all/openhpc.yml)
openhpc_config_extra: {}

# indirection for automatic calculation of configuration:
openhpc_config_groups:
  - enabled: "{{ groups['rebuild'] | length > 0 }}"
    config: "{{ openhpc_config_rebuild }}"
  - enabled: "{{ groups['nhc'] | length > 0 }}"
    config: "{{ openhpc_config_nhc }}"
  - enabled: true
    config: "{{ openhpc_config_extra }}"

# construct full config for stackpc.openhpc:
openhpc_config: "{{ openhpc_config_default | combine(openhpc_config_groups | selectattr('enabled') | map(attribute='config'), list_merge='append') }}"

openhpc_install_type: ohpc # 'ohpc' or 'generic', see https://github.com/stackhpc/ansible-slurm-appliance/pull/326

# Empty repo lists from stackhpc.openhpc role defaults, as these repofiles are
# now generated by dnf_repos to allow injecting Ark creds:
ohpc_openhpc_repos:
  "9": []
  "8": []

# overriding to ensure doesn't overwrite Ark epel repo
ohpc_default_extra_repos:
  "9": []
  "8": []
