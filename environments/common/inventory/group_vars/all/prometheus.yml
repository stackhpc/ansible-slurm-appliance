---
# See: https://github.com/cloudalchemy/ansible-prometheus
# for variable definitions

prometheus_web_external_url: "http://{{ prometheus_address }}:9090"
prometheus_storage_retention: "31d"
prometheus_storage_retention_size: "100GB"

prometheus_alertmanager_config: []

prometheus_alert_rules_files:
- "{{ appliances_repository_root }}/environments/common/files/prometheus/rules/*.rules"

prometheus_alert_rules: []

prometheus_targets:
  node: "{{ groups.get('node_exporter', []) | reject('equalto', 'localhost') | prometheus_node_exporter_targets }}"

prometheus_scrape_configs_default:
- job_name: "prometheus"
  metrics_path: "/metrics"
  static_configs:
  - targets:
    - "{{ prometheus_address }}:9090"
- job_name: "grafana"
  static_configs:
  - targets:
    - "{{ grafana_api_address }}:{{ grafana_port }}"
- job_name: "node"
  file_sd_configs:
  - files:
    - "/etc/prometheus/file_sd/node.yml"
  relabel_configs:
  # strip off port
  - source_labels: ['__address__']
    separator:     ':'
    regex:         '(.*):.*'
    target_label:  'instance'
    replacement:   '${1}'
  params:
    collect[]:
      - netdev
      - cpu
      - meminfo
      - infiniband
      - cpufreq
  scrape_interval: 30s
  scrape_timeout: 20s
- job_name: slurm
  metrics_path: /probe
  params:
    module: [tcp_connect]
  static_configs:
    - targets:
      - "http://{{ openhpc_slurm_control_host }}:6817"
    - targets:
      - "http://{{ groups['login'] | first }} :6818" # FIXME: want all login and compute nodes
  relabel_configs:
    - source_labels: [__address__]
      target_label: __param_target
    - source_labels: [__param_target]
      target_label: instance
    - target_label: __address__
      replacement: "{{ blackbox_exporter_address }}:9115"  # Blackbox exporter

prometheus_scrape_configs: "{{ prometheus_scrape_configs_default + (openondemand_scrape_configs if groups['openondemand'] | count > 0 else []) }}"
