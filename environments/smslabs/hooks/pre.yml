- hosts: localhost
  become: false
  tags: build
  tasks:
    - name: Ensure secrets generated
      include_role:
        name: passwords
    
    - name: Build packer images
      shell:
        cmd: |
          cd packer
          PACKER_LOG=1 packer build -on-error=ask -var-file=$PKR_VAR_environment_root/builder.pkrvars.hcl openstack.pkr.hcl
        chdir: "{{ lookup('env', 'APPLIANCES_REPO_ROOT') }}"
      when: "'builder' not in group_names" # avoid recursion!
      register: packer_run
      async: 2700 # 45 minutes
      poll: 0

# For some reason squid shows TCP_MISS_ABORTED/200 on everything
# - hosts: all
#   become: yes
#   gather_facts: no
#   tasks:
#     - name: Configure dnf proxy
#       community.general.ini_file:
#         path: /etc/dnf/dnf.conf
#         section: main
#         option: proxy
#         value: "{{ squid_proxy }}"
#         no_extra_spaces: true
