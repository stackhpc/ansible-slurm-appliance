# - name: Import parent hook
#   vars:
#     appliances_environment_root: "{{ lookup('env', 'APPLIANCES_ENVIRONMENT_ROOT') }}"
#   ansible.builtin.import_playbook: "{{ appliances_environment_root }}/../nrel/hooks/pre.yml"

- name: "Add a stack admin user"
  hosts: all
  # tags: pre_tasks_all
  become: true
  gather_facts: true
  tasks:
    - name: Does localhome/stack dir exist
      ansible.builtin.stat:
        path: /localhome/stack
      register: localstack

    # - name: Does localhome/rocky dir exist
    #   ansible.builtin.stat:
    #     path: /localhome/rocky
    #   register: localrockyuserdir

    - name: Add stack user
      ansible.builtin.include_role:
        name: vs.core.stack_user
      when: not localstack.stat.exists

    # - name: Add rocky user role
    #   ansible.builtin.include_role:
    #     name: vshpc.rocky_user
    #   when: not localrockyuserdir.stat.exists
    #   tags:
    #     - add_stack_user
  tags:
    - add_stack_user

- name: A cp user home to /var/lib/USER
  hosts: all
  # tags: pre_tasks_all
  become: true
  gather_facts: false

  # tasks:
  #   - name: Does home/USER dir exist
  #     ansible.builtin.stat:
  #       path: "/home/{{ appliances_local_users_ansible_user_name }}"
  #     register: homerocky

  #   - name: Does var/lib/rocky dir exist
  #     ansible.builtin.stat:
  #       path: "/var/lib/{{ appliances_local_users_ansible_user_name }}"
  #     register: varlibrocky

  #   - name: Cp homerocky to var/lib/ dir
  #     ansible.builtin.command: cp -a /home/{{ appliances_local_users_ansible_user_name }} /var/lib/{{ appliances_local_users_ansible_user_name }}
  #     when:
  #       - homerocky.stat.exists
  #     register: cph
  #     changed_when: cph.rc != 0

  #   # - name: cp auth_keys
  #   #   shell: |
  #   #     cp -a /home/rocky/.ssh /var/lib/rocky/.ssh
  #   #   when:
  #   #     - varlibrocky.stat.exists
  #   #     - homerocky.stat.exists

  #   - name: Hack passwd file for localhome/rocky
  #     ansible.builtin.lineinfile:
  #       path: /etc/passwd
  #       regexp: '^rocky.*1000.*'
  #       line: "rocky:x:1000:1000:vsRockyUser:/var/lib/{{ appliances_local_users_ansible_user_name }}:/bin/bash"
  # tags:
  #   - rocky_localhome

- name: "Do the preliminary node setups"
  hosts: all
  # tags: pre_tasks_all
  become: true
  tasks:
    - name: Does vs_pre_complete.txt exist
      ansible.builtin.stat:
        path: /root/vs_pre_complete.txt
      register: vs_pre_complete

    - name: Pre tasks now
      ansible.builtin.include_role:
        name: vshpc.prov.pre-tasks
      when: not vs_pre_complete.stat.exists

# TODO: KBENDL - check compatibility with new playbook
- name: "NREL pre - Mount cephfs volumes"
  hosts: all
  tags:
    - vs_pre
    - aco.core.cephfs
  become: true
  tasks:
    - name: Does ceph exist?
      ansible.builtin.stat:
        path: /etc/ceph
      register: vs_does_cephdir
    - name: CephFS now
      ansible.builtin.include_role:
        name: aco.core.cephfs
      tags:
        - aco.core.cephfs
      when: not vs_does_cephdir.stat.exists
